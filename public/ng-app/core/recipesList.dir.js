(function() {
	'use strict';

	angular
		.module('rBox')
		.directive('recipesList', recipesList);

	recipesList.$inject = ['Recipe'];

	function recipesList(Recipe) {

		recipesListCtrl.$inject = ['$scope'];

		function recipesListCtrl($scope) {
			// controllerAs view model
			var rl = this;

			// build out the total time and number of ingredients for sorting
			var _watchRecipes = $scope.$watch('rl.recipes', function(newVal, oldVal) {
				if (newVal) {
					angular.forEach(rl.recipes, function(recipe) {
						recipe.totalTime = (recipe.cookTime ? recipe.cookTime : 0) + (recipe.prepTime ? recipe.prepTime : 0);
						recipe.nIng = recipe.ingredients.length;
					});
					// deregister the watch
					_watchRecipes();
				}
			});

			// conditionally show category / tag filters
			// always show special diet filter
			if (rl.categoryFilter === 'true') {
				rl.categories = Recipe.categories;
				rl.showCategoryFilter = true;
			}
			if (rl.tagFilter === 'true') {
				rl.tags = Recipe.tags;
				rl.showTagFilter = true;
			}
			rl.specialDiet = Recipe.dietary;

			// set all filters to empty
			rl.filterPredicates = {};

			function _resetFilterPredicates() {
				rl.filterPredicates.cat = '';
				rl.filterPredicates.tag = '';
				rl.filterPredicates.diet = '';
			}

			// set up sort predicate and reversals
			rl.sortPredicate = 'name';

			rl.reverseObj = {
				name: false,
				totalTime: false,
				nIng: false
			};
			var _lastSortedBy = 'name';

			/**
			 * Toggle sort asc/desc
			 *
			 * @param predicate {string}
			 */
			rl.toggleSort = function(predicate) {
				if (_lastSortedBy === predicate) {
					rl.reverseObj[predicate] = !rl.reverseObj[predicate];
				}
				rl.reverse = rl.reverseObj[predicate];
				_lastSortedBy = predicate;
			};

			// number of recipes to show/add in a set
			var _resultsSet = 15;

			/**
			 * Reset results showing to initial default on search/filter
			 *
			 * @private
			 */
			function _resetResultsShowing() {
				rl.nResultsShowing = _resultsSet;
			}
			_resetResultsShowing();

			/**
			 * Load More results
			 */
			rl.loadMore = function() {
				rl.nResultsShowing = rl.nResultsShowing += _resultsSet;
			};

			// watch search query and if it exists, clear filters and reset results showing
			$scope.$watch('rl.query', function(newVal, oldVal) {
				if (!!rl.query) {
					_resetFilterPredicates();
					_resetResultsShowing();
				}
			});

			// watch filters and if any of them change, reset the results showing
			$scope.$watch('rl.filterPredicates', function(newVal, oldVal) {
				if (!!newVal && newVal !== oldVal) {
					_resetResultsShowing();
				}
			});

			var _openFiltersOnload = $scope.$watch('rl.openFilters', function(newVal, oldVal) {
				if (newVal !== undefined) {
					rl.showSearchFilter = newVal === 'true';
					_openFiltersOnload();
				}
			});

			/**
			 * Toggle search/filter section open/closed
			 */
			rl.toggleSearchFilter = function() {
				rl.showSearchFilter = !rl.showSearchFilter;
			};

			/**
			 * Clear search query and all filters
			 */
			rl.clearSearchFilter = function() {
				_resetFilterPredicates();
				rl.query = '';
			};

			/**
			 * Show number of currently active search + filter items
			 *
			 * @param query {string}
			 * @param filtersObj {object}
			 * @returns {number}
			 */
			rl.activeSearchFilters = function(query, filtersObj) {
				var total = 0;

				if (query) {
					total = total += 1;
				}
				angular.forEach(filtersObj, function(filter) {
					if (filter) {
						total = total += 1;
					}
				});

				return total;
			};
		}

		recipesListLink.$inject = ['$scope', '$attrs', '$elem'];

		function recipesListLink($scope, $attrs, $elem) {
			$scope.rll = {};

			// watch the currently visible number of recipes to display a count
			$scope.$watch(
				function() {
					return angular.element('.recipesList-list-item').length;
				},
				function(newVal, oldVal) {
					if (newVal) {
						$scope.rll.displayedResults = newVal;
					}
				}
			);
		}

		return {
			restrict: 'EA',
			scope: {
				recipes: '=',
				openFilters: '@',
				customLabels: '@',
				categoryFilter: '@',
				tagFilter: '@'
			},
			templateUrl: 'ng-app/core/recipesList.tpl.html',
			controller: recipesListCtrl,
			controllerAs: 'rl',
			bindToController: true,
			link: recipesListLink
		}
	}
})();