(function() {
	'use strict';

	angular
		.module('rBox')
		.directive('recipesList', recipesList);

	function recipesList() {
		// return directive
		return {
			restrict: 'EA',
			scope: {
				recipes: '=',
				openFilters: '@',
				customLabels: '@',
				categoryFilter: '@',
				tagFilter: '@'
			},
			templateUrl: 'ng-app/core/recipes/recipesList.tpl.html',
			controller: recipesListCtrl,
			controllerAs: 'rl',
			bindToController: true,
			link: recipesListLink
		};

		/**
		 * recipesList LINK function
		 *
		 * @param $scope
		 */
		function recipesListLink($scope) {
			$scope.rll = {};

			// watch the currently visible number of recipes to display a count
			$scope.$watch(
				function() {
					return angular.element('.recipesList-list-item').length;
				},
				_$watchRecipesList
			);

			/**
			 * $watch recipesList list items
			 *
			 * @param newVal
			 * @param oldVal
			 * @private
			 */
			function _$watchRecipesList(newVal, oldVal) {
				if (newVal) {
					$scope.rll.displayedResults = newVal;
				}
			}
		}
	}

	recipesListCtrl.$inject = ['$scope', 'Recipe'];

	/**
	 * recipesList CONTROLLER
	 *
	 * @param $scope
	 * @param Recipe
	 */
	function recipesListCtrl($scope, Recipe) {
		// controllerAs view model
		var rl = this;

		// build out the total time and number of ingredients for sorting
		var _watchRecipes = $scope.$watch('rl.recipes', function(newVal, oldVal) {
			if (newVal) {
				angular.forEach(rl.recipes, function(recipe) {
					recipe.totalTime = (recipe.cookTime ? recipe.cookTime : 0) + (recipe.prepTime ? recipe.prepTime : 0);
					recipe.nIng = recipe.ingredients.length;
				});
				// deregister the watch
				_watchRecipes();
			}
		});
		var _lastSortedBy = 'name';
		var _resultsSet = 15;   // number of recipes to show/add in a set

		var _openFiltersOnload = $scope.$watch('rl.openFilters', function(newVal, oldVal) {
			if (angular.isDefined(newVal)) {
				rl.showSearchFilter = newVal === 'true';
				_openFiltersOnload();
			}
		});

		// conditionally show category / tag filters
		// always show special diet filter
		if (rl.categoryFilter === 'true') {
			rl.categories = Recipe.categories;
			rl.showCategoryFilter = true;
		}
		if (rl.tagFilter === 'true') {
			rl.tags = Recipe.tags;
			rl.showTagFilter = true;
		}
		rl.specialDiet = Recipe.dietary;

		// set all filters to empty
		rl.filterPredicates = {};

		// set up sort predicate and reversals
		rl.sortPredicate = 'name';

		rl.reverseObj = {
			name: false,
			totalTime: false,
			nIng: false
		};

		rl.toggleSort = toggleSort;
		rl.loadMore = loadMore;
		rl.toggleSearchFilter = toggleSearchFilter;
		rl.clearSearchFilter = clearSearchFilter;
		rl.activeSearchFilters = activeSearchFilters;

		/**
		 * Reset filter predicates
		 *
		 * @private
		 */
		function _resetFilterPredicates() {
			rl.filterPredicates.cat = '';
			rl.filterPredicates.tag = '';
			rl.filterPredicates.diet = '';
		}

		/**
		 * Toggle sort asc/desc
		 *
		 * @param predicate {string}
		 */
		function toggleSort(predicate) {
			if (_lastSortedBy === predicate) {
				rl.reverseObj[predicate] = !rl.reverseObj[predicate];
			}
			rl.reverse = rl.reverseObj[predicate];
			_lastSortedBy = predicate;
		}

		/**
		 * Reset results showing to initial default on search/filter
		 *
		 * @private
		 */
		function _resetResultsShowing() {
			rl.nResultsShowing = _resultsSet;
		}
		_resetResultsShowing();

		/**
		 * Load More results
		 */
		function loadMore() {
			rl.nResultsShowing = rl.nResultsShowing += _resultsSet;
		}

		$scope.$watch('rl.query', _$watchQuery);

		/**
		 * $watch search query and if it exists, clear filters and reset results showing
		 *
		 * @param newVal
		 * @param oldVal
		 * @private
		 */
		function _$watchQuery(newVal, oldVal) {
			if (rl.query) {
				_resetFilterPredicates();
				_resetResultsShowing();
			}
		}

		$scope.$watch('rl.filterPredicates', _$watchPredicates);

		/**
		 * $watch filterPredicates
		 * watch filters and if any of them change, reset the results showing
		 *
		 * @param newVal
		 * @param oldVal
		 * @private
		 */
		function _$watchPredicates(newVal, oldVal) {
			if (!!newVal && newVal !== oldVal) {
				_resetResultsShowing();
			}
		}

		/**
		 * Toggle search/filter section open/closed
		 */
		function toggleSearchFilter() {
			rl.showSearchFilter = !rl.showSearchFilter;
		}

		/**
		 * Clear search query and all filters
		 */
		function clearSearchFilter() {
			_resetFilterPredicates();
			rl.query = '';
		}

		/**
		 * Show number of currently active search + filter items
		 *
		 * @param query {string}
		 * @param filtersObj {object}
		 * @returns {number}
		 */
		function activeSearchFilters(query, filtersObj) {
			var total = 0;

			if (query) {
				total = total += 1;
			}
			angular.forEach(filtersObj, function(filter) {
				if (filter) {
					total = total += 1;
				}
			});

			return total;
		}
	}
}());